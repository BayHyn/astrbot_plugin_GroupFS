# GroupFS for AstrBot - QQ群文件管理插件

![License](https://img.shields.io/badge/license-MIT-green)
![Python](https://img.shields.io/badge/python-3.10+-blue.svg)
![AstrBot](https://img.shields.io/badge/framework-AstrBot-orange)

一款为 [AstrBot](https://github.com/AstrBotDevs/AstrBot) 设计的强大QQ群文件管理插件，旨在简化和自动化群组的文件维护工作，并提供智能监控预警。

## ✨ 功能特色

### ✓ 已实现功能

* **文件搜索与预览**:
  * 使用 `/sf <文件名>` 指令，任何群成员都可以方便地搜索文件。
  * 使用 `/sf <文件名> <序号>` 指令，可预览 `.txt`, `.md`, `.zip` 等多种格式文件的部分内容。
* **文件删除 (管理员)**:
  * 使用 `/df <文件名> [序号]` 指令进行精准删除。
  * 使用 `/df <文件名> 0` 可批量删除所有搜索结果。
* **失效文件管理 (管理员)**:
  * 使用 `/cf` 指令，可批量扫描全群文件，并生成一份详细的失效文件报告。
  * 使用 `/cdf` 指令，可在扫描后一键自动删除所有已失效的文件。
* **自动化维护**:
  * **定时扫描**: 可在配置文件中设置 Cron 表达式，让机器人在指定时间（如每周一凌晨）自动执行失效文件检查，并将报告发送到群聊。
  * **容量监控**: 可设置文件数量和空间占用的阈值，当有成员上传文件并达到上限时，机器人会自动在群内发送警告。
* **体验优化**:
  * **长消息自动转发**: 当插件的回复过长时（如搜索结果或检查报告），会自动转为合并转发，避免刷屏。转发阈值可在配置文件中自定义。

### 🚀 未来计划

* **智能查重**:
  * 在文件上传时，通过正则识别文件名，并与现有文件进行比对，对疑似重复的文件进行提醒。
  * 未来可能引入文件哈希校验，以实现更精准的重复文件判断。

---

## 💿 安装与依赖

1. **安装插件**: 下载本插件的完整文件夹 `astrbot_plugin_groupfs` 及其附带的 `utils.py` 文件，并将它们一同放入 AstrBot 的 `data/plugins/` 目录下。
2. **安装依赖库**: 本插件需要 `aiohttp`, `chardet` 和 `croniter` 库。请在您的机器人运行环境中执行：
    ```bash
    pip install aiohttp chardet croniter
    ```
3. **重启机器人**: 彻底重启您的 AstrBot 主程序（例如使用 `docker restart`），以确保插件和依赖被正确加载。

---

## ⚙️ 配置

插件的配置项定义在 `_conf_schema.json` 文件中，您可以在 AstrBot 的管理后台方便地进行图形化配置。

| 配置项 | 类型 | 描述 |
| :--- | :--- | :--- |
| `group_whitelist` | `list` | 群组白名单。插件指令只在列表中的群组生效。若留空，则对所有群组生效。 |
| `admin_users` | `list` | 管理员QQ列表。只有在此列表中的用户才有权使用管理指令。为了安全，强烈建议配置此项！ |
| `preview_length` | `int` | 文本预览长度。使用 `/sf ... <序号>` 指令时，显示的内容预览的最大字符数。默认为 300。 |
| **`enable_zip_preview`** | **`bool`** | **新增。启用对 `.zip` 压缩包内文本文件的预览功能。** |
| **`default_zip_password`** | **`str`** | **新增。当尝试预览加密的 `.zip` 文件时，会首先使用此密码尝试解压。** |
| `storage_limits` | `list` | 群文件容量监控阈值。格式为 `"群号:文件数量上限:空间上限GB"` 的字符串列表，例如 `"123456:9000:9.5"`。 |
| `scheduled_check_tasks` | `list` | 定时失效文件检查任务。格式为 `"群号:cron表达式"`，例如 `"123456:0 3 * * 1"` 代表每周一凌晨3点检查。 |
| `forward_threshold` | `int` | 长消息合并转发阈值。当插件的单条回覆超过此字数时，将自动转为合并转发。设置为 0 则禁用此功能。 |

---

## 📖 使用方法

确保机器人在目标群组拥有管理员权限，否则它无法获取文件列表或执行删除、检查等操作。

### 搜索与预览 (所有成员)

* **搜索文件**: `/sf 文件关键词`
  * > `/sf 活着`
* **预览文件**: `/sf 文件关键词 序号`
  * > `/sf 活着 1`

### 文件管理 (仅限管理员)

* **删除单个文件**: `/df 文件关键词 序号`
  * > `/df 活着 2`
* **批量删除搜索结果**: `/df 文件关键词 0`
  * > `/df 活着 0`
* **检查失效文件 (仅报告)**: `/cf`
* **检查并删除失效文件 (自动清理)**: `/cdf`

### 自动化功能

* **容量监控**与**定时检查**均为被动触发功能，只需在配置文件中正确设置，插件便会自动在后台执行。

---

## 📝 更新日志

* **v0.8**
  * 新增 压缩包预览 功能，支持使用 `/sf` 指令预览 `.zip` 文件中首个 `.txt` 文件的内容，并增加了 **`enable_zip_preview`** 和 **`default_zip_password`** 两个配置项。
* **v0.7**
  * 新增 长消息自动合并转发 功能，可自定义触发转发的字数阈值，避免过长的报告刷屏。
* **v0.6**
  * 新增 定时任务 功能，可按 Cron 表达式配置，在指定时间自动执行失效文件检查并发送报告。
  * 优化项目结构，将部分辅助函数迁移至独立的 `utils.py` 文件。
* **v0.5**
  * 新增 批量检查指令 (`/cf`)，可扫描全群文件并生成详细的失效文件报告。
  * 新增 批量清理指令 (`/cdf`)，可一键扫描并自动删除群内所有失效文件。
  * 优化 删除指令 (`/df`)，增加按序号 `0` 批量删除所有搜索结果的功能。
* **v0.4**
  * 新增 群文件容量监控 功能，可在文件上传后自动检测容量与数量，并在达到阈值时发送提醒。
* **v0.3**
  * 新增 文本文件预览 功能，可通过 `/sf ... <序号>` 指令查看多种格式的文本文件内容，并能识别失效文件。
* **v0.2**
  * 新增 独立的文件搜索指令 (`/sf`)；同时优化删除指令 (`/df`)，支持在返回多个结果时，通过指定序号进行精准删除。
* **v0.1**
  * 初步实现 基础的文件删除 功能，允许管理员通过 `/df <文件名>` 指令管理群文件。

---

## ❤️ 支持

* [AstrBot 帮助文档](https://astrbot.app)
* 如果您在使用中遇到问题，欢迎在本仓库提交 [Issue](https://github.com/Foolllll-J/astrbot_plugin_GroupFS/issues)。

